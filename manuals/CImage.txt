Visual C++ªºCBitmap‹Ýªº¥\¯à¬O¤ñ†]®zªº,¥¦¥u¯àF¥Ü¥X¦b†V·½¤¤ªº†¶‡á¡B¦ì†¶¡B¥ú‡á¥H¤Î†¶¤¸¤å¥óªºX®e¡A¦Ó¤£¹³VB¤¤ªºImage±±¥ó¥i¥HF¥Ü¥X…E¤j¦h‡Ûªº¥~³¡†¶¹³¤å¥ó(BMP¡BGIF¡BJPEGµ¥)¡C¦pªG·Q­n¦b†Á†O®Ø©Î¨ä¥Lµ¡¤f¤¤F¥Ü¥~³¡†¶¹³¤å¥óƒh¥u¯à­É§U¤_²Ä¤T¤è´£¨Ñªº±±¥ó©Î¥N‡ù,¥¼§K†e¤_Ác†ã. 
   „c¦b¡A.net¤Þ¤J¤F¤@ƒª¥\¯à«D±`„F¤jªº·s‹Ý ----- CImage.¦³¤FCImage‹Ý,Visual C++¦b†¶¹³¤è­±ªº¯Ê¾Ñ’â¤@¥h¤£Î`ªð¡CCImage¬OMFC©MATL¦@¨Éªº·s‹Ý¡A¥¦¯à„G¥~³¡ºÏ‡÷¤¤ˆ`¤J¤@ƒªJPEG¡BGIF¡BBMP©MPNG®æ¦¡ªº†¶¹³¤å¥ó¥[¥HF¥Ü¡A¦Ó¥B„±¨Ç¤å¥ó®æ¦¡¥i¥H¬Û¤¬‹H„ã¡C¨Ò¦p³q†eŠé„Ëªº¤L¥y,´N¥i¥H†¿„cCImage‹Ý©MCBitmap‹Ý†¿¨Òªº:

HBITMAP hBitmap=image.Detach();
CBitmap bmp;
bmp.Attach(hBitmap);

„±‡Þ¤@ƒS,´N¤S¦^ŠÐ¨ì¥H«e¾ÞŠLCBitmapªº¤è¦¡¤F.CImage¥»¨­«Ê†E¤FDIB(„¦„ÂÆÓ‹×¦ì†¶)ªº¥\¯à¡A¦]¦Ó¯àƒú„z²z¨Cƒª¦ì†¶¹³¯À¡C
¥¦¨ã¦³¤U¦C³Ì»Å¯S©Ê¡G
¡@¡@1¡BAlphaBlend¤ä«ù¹³¯ÀƒËªº‹^¦â²V¦X¡A„G¦Ó†¿„c³z©ú©M¥b³z©úªº®ÄªG¡C
¡@¡@2¡BPlgBlt¯à¨Ï¤@ƒª¯x§Îƒñ°ìªº¦ì†¶¬M®g¨ì¤@ƒª¥­¦æ¥|‹Ê§Îƒñ°ì¤¤¡A¦Ó¥BŠx¥i¯à¨Ï¥Î¦ì«Ì½ª¾Þ§@¡C
¡@¡@3¡BTransparentBlt¦b¥Ø‡áƒñ°ì¤¤„d¥Í³z©ú†¶¹³¡ASetTransparentColor¥ÎƒS„¦¸m¬YÏú‹^¦â¬O³z©ú¦â¡C
¡@¡@4¡BMaskBlt¦b¥Ø‡áƒñ°ì¤¤„d¥Í·½¦ì†¶ÉO«Ì½ª¦ì†¶¦X¦¨ªº®ÄªG¡C

¥Ñ¤_CImage¦b¤£¦PªºWindows¾Þ§@¨t„i¤¤¨ä¬Y¨Ç©Ê¯à¬O¤£¤@‡Þªº¡A¦]¦¹¦b¨Ï¥Îƒº­n¯Sgª`·N¡C¨Ò¦p¡ACImage::PlgBlt©M CImage::MaskBlt¥u¯à¦b Windows NT 4.0 ©Î§ó°ªª©¥»¤¤¨Ï¥Î¡A¦ý¤£¯à†b¦æ¦bWindows 95/98 ‰Ø¥Îµ{§Ç¤¤¡CCImage::AlphaBlend©MCImage::TransparentBlt¤]¥u¯à¦b Windows 2000/98©Î¨ä§ó°ªª©¥»¤¤¨Ï¥Î¡C§Y¨Ï¦bWindows 2000†b¦æµ{§ÇŠx¥²…§’âstdafx.h¤å¥ó¤¤ªºWINVER©M_WIN32_WINNTªº†{©w…ó­×§ï¦¨0x0500¤~¯à¥¿±`¨Ï¥Î¡C

¨Ï¥ÎCImageªº¤@¯ë¤èªk

¡@¡@¨Ï¥ÎCImageªº¤@¯ë¤èªk¬O„±‡Þªº†eµ{¡G

¡@¡@(1) ¥´…{‰Ø¥Îµ{§Çªºstdafx.h¤å¥ó²K¥[CImage‹Ýªº¥]§t¤å¥ó¡G

#include ¡Õatlimage.h¡Ö

¡@¡@(2) ©w…ó¤@ƒªCImage‹Ý†Á¶H¡AµM¦Zˆ`¥ÎCImage::Load¤èªk†E†^¤@ƒª¥~³¡†¶¹³¤å¥ó¡C

¡@¡@(3) ˆ`¥ÎCImage::Draw¤èªk‹³¨î†¶¹³¡CDraw¤èªk¨ã¦³¦p¤U©w…ó¡G

BOOL Draw( HDC hDestDC, int xDest, int yDest,
int nDestWidth, int nDestHeight, int xSrc, int ySrc,
int nSrcWidth, int nSrcHeight );
BOOL Draw( HDC hDestDC, const RECT& rectDest, const RECT& rectSrc );
BOOL Draw( HDC hDestDC, int xDest, int yDest );
BOOL Draw( HDC hDestDC, const POINT& pointDest );
BOOL Draw( HDC hDestDC, int xDest, int yDest,
int nDestWidth, int nDestHeight );
BOOL Draw( HDC hDestDC, const RECT& rectDest ); 



¡@¡@¨ä¤¤¡AhDestDC¥ÎƒS«ü©w‹³¨îªº¥Ø‡á„¦„Â‰ø¹Ò¥y¬`¡A(xDest, yDest)©MpointDest¥ÎƒS«ü©w†¶¹³F¥Üªº¦ì¸m¡A„±ƒª¦ì¸m©M·½†¶¹³ªº¥ª¤W¨¤Š»¬Û†Á‰Ø¡CnDestWidth©MnDestHeight¤Àg«ü©w†¶¹³­nF¥Üªº°ª«×©M‡¾«×¡AxSrc¡BySrc¡BnSrcWidth©MnSrcHeight¥ÎƒS«ü©w­nF¥Üªº·½†¶¹³ªº¬Yƒª³¡¤À©Ò¦bªº¦ì¸m©M¤j¤p¡C rectDest©MrectSrc¤Àg¥ÎƒS«ü©w¥Ø‡á„¦„Â‰ø¹Ò¤W©M·½†¶¹³©Ò­nF¥Üªº¬Yƒª³¡¤Àªº¦ì¸m©M¤j¤p¡C

¡@¡@»Ý­n‡S©úªº¬O¡ADraw¤èªk†ö¦X¤FStretchBlt¡BTransparentBlt©MAlphaBlend¨ç‡Ûªº¥\¯à¡CÀq‡Pƒº¡ADrawªº¥\¯à©M StretchBlt¬Û¦P¡C¦ý…å†¶¹³§t¦³³z©ú¦â©ÎAlpha³q¹Dƒº¡A¥¦ªº¥\¯à¤S©MTransparentBlt¡BAlphaBlend¬Û¦P¡C¦]¦¹¡A¦b¤@¯ë±¡•Õ¤U¡A§Úƒ¨³£‰Ø†G†é¶qˆ`¥ÎCImage::Draw¤èªkƒS‹³¨î†¶¹³¡C

¡@¡@¨Ò¦p¡A¤U­±ªº¥Ü¨ÒEx_Image¬O†¿„c„±‡Þªº¥\¯à¡G…å‰uˆá"¤å¥ó" ã"¥´…{"µæ„Ë©R¥O¦Z¡A‡É¥X¤@ƒª¤å¥ó¥´…{†Á†O®Ø¡C…å‰u©w¤@ƒª†¶¹³¤å¥ó¦Z¡A´N…Ñ¦bµ¡¤f«È‚þƒñ¤¤F¥Ü†G†¶¹³¤å¥óX®e¡C„±ƒª¥Ü¨Òªº¨ãÊ^¨Bb¦p¤U¡G

¡@¡@(1) „Ç«Ø¤@ƒªÀq‡Pªº„Ë¤å‰ãµ{§Ç…¥¥ØEx_Image¡C

¡@¡@(2) ¥´…{stdafx.h¤å¥ó¤¤²K¥[CImage‹Ýªº¥]§t¤å¥óatlimage.h¡C

¡@¡@(3) ¦bCEx_ImageView‹Ý²K¥[ID_FILE_OPENªºCOMMAND¨Æ¥ó¬M®gµ{§Ç¡A¦}²K¥[¤U¦C¥N‡ù¡G

void CEx_ImageView::OnFileOpen()
{
¡@CString strFilter;
¡@CSimpleArray¡ÕGUID¡Ö aguidFileTypes;
¡@HRESULT hResult;

¡@// ‰÷¨úCImage¤ä«ùªº†¶¹³¤å¥óªº†eŠÔ¦r²Å¦ê
¡@hResult = m_Image.GetExporterFilterString(strFilter,aguidFileTypes,
_T( "All Image Files") );
¡@if (FAILED(hResult)) {
¡@¡@MessageBox("GetExporterFilterˆ`¥Î¥¢„P¡I");
¡@¡@return;
¡@}
¡@CFileDialog dlg(TRUE, NULL, NULL, OFN_FILEMUSTEXIST, strFilter);
¡@if(IDOK != dlg.DoModal()) 
¡@¡@return;

¡@m_Image.Destroy();
¡@// ’â¥~³¡†¶¹³¤å¥ó†E†^¨ìCImage†Á¶H¤¤
¡@hResult = m_Image.Load(dlg.GetFileName());
¡@if (FAILED(hResult)) {
¡@¡@MessageBox("ˆ`¥Î†¶¹³¤å¥ó¥¢„P¡I");
¡@¡@return;
¡@}

¡@// „¦¸m¥Dµ¡¤f‡á‹_ŒwX®e
¡@CString str;
¡@str.LoadString(AFX_IDS_APP_TITLE);
¡@AfxGetMainWnd()-¡ÖSetWindowText(str + " - " +dlg.GetFileName());

¡@Invalidate(); // „F¨îˆ`¥ÎOnDraw
} 



¡@¡@(4) ©w¦ì¨ìCEx_ImageView::OnDraw¨ç‡Û„z¡A²K¥[¤U¦C¥N‡ù¡G

void CEx_ImageView::OnDraw(CDC* pDC)
{
¡@CEx_ImageDoc* pDoc = GetDocument();
¡@ASSERT_VALID(pDoc);
¡@if (!m_Image.IsNull()) {
¡@¡@m_Image.Draw(pDC-¡Öm_hDC,0,0);
¡@}
} 



¡@¡@(5) ¥´…{Ex_ImageView.h¤å¥ó¡A²K¥[¤@ƒª¤½¦@ªº¦¨ƒ°‡ÛÕum_Image¡G

public:
CImage m_Image; 



¡@¡@(6) ˆCŒW¦}†b¦æ¡C„Ë‰Û"¥´…{"¤u¨ã«ö…r¡A¦b‡É¥Xªº†Á†O®Ø¤¤«ü©w¤@ƒª†¶¹³¤å¥ó¦Z¡A„Ë‰Û"¥´…{"«ö…r¡A¨ä…CªG¦p†¶7.21©Ò¥Ü¡C



’â†¶¤ù¥Î¨ä¥¦®æ¦¡«O¦s

¡@¡@CImage::Save¤èªk¯à’â¤@ƒª†¶¹³¤å¥ó«ö¥t¤@Ïú®æ¦¡ƒS«O¦s¡A¥¦ªº­ì«¬¦p¤U¡G

HRESULT Save( LPCTSTR pszFileName, REFGUID guidFileType= GUID_NULL); 

¡@¡@¨ä¤¤¡ApszFileName¥ÎƒS«ü©w¤@ƒª¤å¥ó¦W¡AguidFileType¥ÎƒS«ü©w­n«O¦sªº†¶¹³¤å¥ó®æ¦¡¡A…åƒoGUID_NULLƒº¡A¨ä¤å¥ó®æ¦¡¥Ñ¤å¥óªºŠÃ®i¦WƒSƒK©w¡A„±¤]¬O†G¨ç‡ÛªºÀq‡P­È¡C¥¦Šx¥i¥H¬OGUID_BMPFile(BMP¤å¥ó®æ¦¡)¡BGUID_PNGFile(PNG¤å¥ó®æ¦¡)¡B GUID_JPEGFile(JPEG¤å¥ó®æ¦¡)©MGUID_GIFFile(GIF¤å¥ó®æ¦¡)¡C

¡@¡@¨Ò¦p¡A¤U­±ªº†eµ{¬O¦bEx_Image¥Ü¨Ò°òŠß¤W…n¦æªº¡A§Úƒ¨¦bCEx_ImageView‹Ý²K¥[ID_FILE_SAVE_ASªºCOMMAND¨Æ¥ó¬M®gµ{§Ç¡A¦}²K¥[¤U¦C¥N‡ù¡G


void CEx_ImageView::OnFileSaveAs()
{
¡@if (m_Image.IsNull()) {
¡@¡@MessageBox("§AŠx•Ê¦³¥´…{¤@ƒª­n«O¦sªº†¶¹³¤å¥ó¡I");
¡@¡@return;
¡@}

¡@CString strFilter;
¡@strFilter = "¦ì†¶¤å¥ó|*.bmp|JPEG †¶¹³¤å¥ó|*.jpg| \
GIF †¶¹³¤å¥ó|*.gif|PNG †¶¹³¤å¥ó|*.png||";
¡@CFileDialog dlg(FALSE,NULL,NULL,NULL,strFilter);
¡@if ( IDOK != dlg.DoModal()) 
¡@¡@return;

¡@// ¦pªG¥Î‚þ•Ê¦³«ü©w¤å¥óŠÃ®i¦W¡Aƒhƒo¨ä²K¥[¤@ƒª
¡@CString strFileName;
¡@CString strExtension;

¡@strFileName = dlg.m_ofn.lpstrFile;
¡@if (dlg.m_ofn.nFileExtension == 0) 
¡@{
¡@¡@switch (dlg.m_ofn.nFilterIndex)
¡@¡@{
¡@¡@¡@case 1:
¡@¡@¡@¡@strExtension = "bmp"; break;
¡@¡@¡@case 2:
¡@¡@¡@¡@strExtension = "jpg"; break;
¡@¡@¡@case 3:
¡@¡@¡@¡@strExtension = "gif"; break;
¡@¡@¡@case 4:
¡@¡@¡@¡@strExtension = "png"; break;
¡@¡@¡@default:
¡@¡@¡@¡@break;
¡@¡@}
¡@¡@strFileName = strFileName + '.' + strExtension;
¡@}

¡@// †¶¹³«O¦s
¡@HRESULT hResult = m_Image.Save(strFileName);
¡@if (FAILED(hResult)) 
¡@¡@MessageBox("«O¦s†¶¹³¤å¥ó¥¢„P¡I");

’â†¶¤ù¥Î¨ä¥¦®æ¦¡«O¦s

¡@¡@CImage::Save¤èªk¯à’â¤@ƒª†¶¹³¤å¥ó«ö¥t¤@Ïú®æ¦¡ƒS«O¦s¡A¥¦ªº­ì«¬¦p¤U¡G

HRESULT Save( LPCTSTR pszFileName, REFGUID guidFileType= GUID_NULL); 

¡@¡@¨ä¤¤¡ApszFileName¥ÎƒS«ü©w¤@ƒª¤å¥ó¦W¡AguidFileType¥ÎƒS«ü©w­n«O¦sªº†¶¹³¤å¥ó®æ¦¡¡A…åƒoGUID_NULLƒº¡A¨ä¤å¥ó®æ¦¡¥Ñ¤å¥óªºŠÃ®i¦WƒSƒK©w¡A„±¤]¬O†G¨ç‡ÛªºÀq‡P­È¡C¥¦Šx¥i¥H¬OGUID_BMPFile(BMP¤å¥ó®æ¦¡)¡BGUID_PNGFile(PNG¤å¥ó®æ¦¡)¡B GUID_JPEGFile(JPEG¤å¥ó®æ¦¡)©MGUID_GIFFile(GIF¤å¥ó®æ¦¡)¡C

¡@¡@¨Ò¦p¡A¤U­±ªº†eµ{¬O¦bEx_Image¥Ü¨Ò°òŠß¤W…n¦æªº¡A§Úƒ¨¦bCEx_ImageView‹Ý²K¥[ID_FILE_SAVE_ASªºCOMMAND¨Æ¥ó¬M®gµ{§Ç¡A¦}²K¥[¤U¦C¥N‡ù¡G

void CEx_ImageView::OnFileSaveAs()
{
¡@if (m_Image.IsNull()) {
¡@¡@MessageBox("§AŠx•Ê¦³¥´…{¤@ƒª­n«O¦sªº†¶¹³¤å¥ó¡I");
¡@¡@return;
¡@}

¡@CString strFilter;
¡@strFilter = "¦ì†¶¤å¥ó|*.bmp|JPEG †¶¹³¤å¥ó|*.jpg| \
GIF †¶¹³¤å¥ó|*.gif|PNG †¶¹³¤å¥ó|*.png||";
¡@CFileDialog dlg(FALSE,NULL,NULL,NULL,strFilter);
¡@if ( IDOK != dlg.DoModal()) 
¡@¡@return;

¡@// ¦pªG¥Î‚þ•Ê¦³«ü©w¤å¥óŠÃ®i¦W¡Aƒhƒo¨ä²K¥[¤@ƒª
¡@CString strFileName;
¡@CString strExtension;

¡@strFileName = dlg.m_ofn.lpstrFile;
¡@if (dlg.m_ofn.nFileExtension == 0) 
¡@{
¡@¡@switch (dlg.m_ofn.nFilterIndex)
¡@¡@{
¡@¡@¡@case 1:
¡@¡@¡@¡@strExtension = "bmp"; break;
¡@¡@¡@case 2:
¡@¡@¡@¡@strExtension = "jpg"; break;
¡@¡@¡@case 3:
¡@¡@¡@¡@strExtension = "gif"; break;
¡@¡@¡@case 4:
¡@¡@¡@¡@strExtension = "png"; break;
¡@¡@¡@default:
¡@¡@¡@¡@break;
¡@¡@}
¡@¡@strFileName = strFileName + '.' + strExtension;
¡@}

¡@// †¶¹³«O¦s
¡@HRESULT hResult = m_Image.Save(strFileName);
¡@if (FAILED(hResult)) 
¡@¡@MessageBox("«O¦s†¶¹³¤å¥ó¥¢„P¡I");
@¦¨¶Â¥Õ†¶¤ù

¡@¡@¥Ñ¤_„¥¦h†¶¹³¤å¥ó¨Ï¥Î‹^¦âªíƒS„ú„âF¥Ü„¦„Âªº¦â±mF¥Ü¯à¤O¡A¦]¦Ó’â¤@„E±m¦â†¶¤ù@¦¨¶Â¦â†¶¤ùƒº»Ý­nˆ`¥ÎCImage::IsIndexedƒS§PŠÊ¬O§_¨Ï¥Î‹^¦âªí¡A­Y¬Oƒh­×§ï‹^¦âªí¡A§_ƒhª½±µ’â¹³¯À…n¦æ‹^¦â„¦¸m¡C¨Ò¦p¤U­±ªº¥N‡ù¡G

void CEx_ImageView::MakeBlackAndwhite(CImage* image)
{
¡@if (image-¡ÖIsNull()) return;

¡@if (!image-¡ÖIsIndexed()) {
¡@¡@// ª½±µ­×§ï¹³¯À‹^¦â
¡@¡@COLORREF pixel;
¡@¡@int maxY = image-¡ÖGetHeight(), maxX = image-¡ÖGetWidth();
¡@¡@byte r,g,b,avg;
¡@¡@for (int x=0; x¡ÕmaxX; x++) {
¡@¡@¡@for (int y=0; y¡ÕmaxY; y++) {
¡@¡@¡@¡@pixel = image-¡ÖGetPixel(x,y);
¡@¡@¡@¡@r = GetRValue(pixel);
¡@¡@¡@¡@g = GetGValue(pixel);
¡@¡@¡@¡@b = GetBValue(pixel);
¡@¡@¡@¡@avg = (int)((r + g + b)/3);
¡@¡@¡@¡@image-¡ÖSetPixelRGB(x,y,avg,avg,avg);
¡@¡@¡@}
¡@¡@}
¡@} else {
¡@¡@// ‰÷¨ú¦}­×§ï‹^¦âªí
¡@¡@int MaxColors = image-¡ÖGetMaxColorTableEntries();
¡@¡@RGBQUAD* ColorTable;
¡@¡@ColorTable = new RGBQUAD[MaxColors];
¡@¡@image->GetColorTable(0,MaxColors,ColorTable);
¡@¡@for (int i=0; i¡ÕMaxColors; i++)
¡@¡@{
¡@¡@¡@int avg = (ColorTable[i].rgbBlue + ColorTable[i].rgbGreen + ColorTable[i].rgbRed)/3;
¡@¡@¡@ColorTable[i].rgbBlue = avg;
¡@¡@¡@ColorTable[i].rgbGreen = avg;
¡@¡@¡@ColorTable[i].rgbRed = avg;
¡@¡@}
¡@¡@image->SetColorTable(0,MaxColors,ColorTable);
¡@¡@delete(ColorTable);
¡@}
} 

¡@¡@¦Ü¦¹¡A§Úƒ¨¤¶„j¤FGDI+©MCImageªº¤@¯ë¨Ï¥Î¤èªk©M§Þ¥©¡C…åµM¡A¥¦ƒ¨¥»¨­Šx¦³„¥¦h§ó²`¤Jªº¤èªk¡A¥Ñ¤_½g´T©Ò­­¡A„±¨½¤£¦A¤@¤@ƒÕˆb¡C 
0 0 0 
(ˆ[±z†Á¤å³¹°µ¥X…TÉ²)